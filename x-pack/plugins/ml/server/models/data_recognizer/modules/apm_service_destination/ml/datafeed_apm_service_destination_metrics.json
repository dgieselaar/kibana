{
  "job_id": "JOB_ID",
  "indices": [
    "INDEX_PATTERN_NAME"
  ],
  "chunking_config": {
    "mode": "off"
  },
  "query": {
    "bool": {
      "filter": [
        {
          "term": {
            "processor.event": "metric"
          }
        },
        {
          "term": {
            "metricset.name": "service_destination"
          }
        }
      ]
    }
  },
  "aggregations": {
    "buckets": {
      "composite": {
        "size": 5000,
        "sources": [
          {
            "date": {
              "date_histogram": {
                "field": "@timestamp",
                "fixed_interval": "60s"
              }
            }
          },
          {
            "span.destination.service.resource": {
              "terms": {
                "field": "span.destination.service.resource"
              }
            }
          },
          {
            "service.name": {
              "terms": {
                "field": "service.name"
              }
            }
          }
        ]
      },
      "aggs": {
        "@timestamp": {
          "max": {
            "field": "@timestamp"
          }
        },
        "exit_span_throughput": {
          "rate": {
            "unit": "minute"
          }
        },
        "exit_span_latency_sum": {
          "sum": {
            "field": "span.destination.service.response_time.sum.us"
          }
        },
        "exit_span_latency_count": {
          "sum": {
            "field": "span.destination.service.response_time.count"
          }
        },
        "exit_span_latency": {
          "bucket_script": {
            "buckets_path": {
              "latency_sum": "exit_span_latency_sum",
              "latency_count": "exit_span_latency_count"
            },
            "script": "return params.latency_sum / params.latency_count;"
          }
        },
        "error_count": {
          "filter": {
            "term": {
              "event.outcome": "failure"
            }
          }
        },
        "success_count": {
          "filter": {
            "term": {
              "event.outcome": "success"
            }
          }
        },
        "failed_exit_span_rate": {
          "bucket_script": {
            "buckets_path": {
              "failure_count": "error_count>_count",
              "success_count": "success_count>_count"
            },
            "script": "if ((params.failure_count + params.success_count)==0){return 0;}else{return 100 * (params.failure_count/(params.failure_count + params.success_count));}"
          }
        }
      }
    }
  },
  "indices_options": {
    "ignore_unavailable": true
  }
}
